<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Masking Test</title>
    <script src="javascripts/paper-full.js"></script>
    <script type="text/javascript">

        var bgraster;
        var raster, araster;
        var revealmask, arevealmask;
        var clipgroup, aclipgroup;
        var mypapers = [];

        window.onload = function() {
            // Create Presenter and Audience View
            mypapers[0] = new paper.PaperScope();
            mypapers[1] = new paper.PaperScope();

            // Setup Presenter View
            var canvas = document.getElementById('presCanvas');
            mypapers[0].setup(canvas);
            canvas.style.width = 1200 +'px';
            canvas.style.height = 800 + 'px';
            mypapers[0].view.viewSize.width = 1200;
            mypapers[0].view.viewSize.height = 800;

            bgraster = new mypapers[0].Raster('myImage');
            bgraster.onLoad = function() {
                this.fitBounds(mypapers[0].view.bounds);
            };
            bgraster.opacity = 0.5;
            raster = new mypapers[0].Raster('myImage');
            raster.onLoad = function() {
                this.fitBounds(mypapers[0].view.bounds);
            };
            revealmask = new mypapers[0].CompoundPath();
            clipgroup = new mypapers[0].Group([revealmask, raster]);
            clipgroup.clipped = true;


            // Setup Audience View
            var acanvas = document.getElementById('audCanvas');
            mypapers[1].setup(acanvas);
            acanvas.style.width = 1200 +'px';
            acanvas.style.height = 800 + 'px';
            mypapers[1].view.viewSize.width = 1200;
            mypapers[1].view.viewSize.height = 800;

            // Load an image, and create a clipgroup
            paper = mypapers[1];
            araster = new mypapers[1].Raster('myImage');
            araster.onLoad = function() {
                this.fitBounds(mypapers[1].view.bounds);
            };
            arevealmask = new mypapers[1].CompoundPath();
            aclipgroup = new mypapers[1].Group([arevealmask, araster]);
            aclipgroup.clipped = true;

            // Setup reveal tool
            paper = mypapers[0];
            var revealtool = new paper.Tool();
            revealtool.onMouseDown = revealStart;
            revealtool.onMouseDrag = revealContinue;
            revealtool.onMouseUp = revealEnd;
       };

       var revealpath = null;

       // reveal using simple path
       var fixedw = 15;
       function revealStartSimplePath(evt) { // fixed radius
           revealpath = new mypapers[0].Path();
           revealpath.strokeWidth = fixedw;
           revealpath.strokeColor = 'black';
           revealpath.add(new paper.Point(evt.point));
           revealmask.addChild(revealpath);

       };

       function revealContinueSimplePath(evt) {
           if (revealpath != null) {
                revealpath.add(new mypapers[0].Point(evt.point));
           }
       };

       function revealEndSimplePath(evt) {
           if (revealpath != null) {
               revealpath.add(new mypapers[0].Point(evt.point));
           }
       };

       // reveal using width + path

        var startp = null;
        var widthp = null;
        var timeout = null;
        var inserti;
        var width = 0;
        function revealStart(evt) {
            revealpath = new mypapers[0].Path();
            revealpath.strokeWidth = 2;
            revealpath.strokeColor = 'red';
            startp = new mypapers[0].Point(evt.point);
            revealpath.add(startp);
            inserti = 1;
        };

        function revealContinue(evt) {
            if (revealpath) {
                if (widthp) {
                    var pi = new mypapers[0].Point(evt.point);
                    var pj = new mypapers[0].Point(evt.point.x, evt.point.y - width);
                    revealpath.insert(inserti, pi);
                    inserti += 1;
                    revealpath.insert(inserti, pj);

                    paper = mypapers[1];
                    var acloned = revealpath.clone();
                    acloned.clockwise = false;
                    arevealmask.addChild(acloned);

                    var aprevgroup = aclipgroup;
                    aclipgroup = new paper.Group([arevealmask, araster]);
                    aclipgroup.clipped = true;
                    aprevgroup.remove();

                } else {
                    // Wait for 0.5 sec stop
                    revealpath.add(new mypapers[0].Point(evt.point));
                    inserti += 1;
                    if (timeout) {
                        clearTimeout(timeout);
                    }
                    timeout = setTimeout(function() {
                        widthp = new mypapers[0].Point(evt.point);
                        width = widthp.y - startp.y;
                        revealpath.strokeColor = 'blue';
                        revealpath.dashArray = [5,2];
                    }, 300)
                }
            }
        };

        function revealEnd(evt) {
            if (revealpath) {

                paper = mypapers[1];
                var acloned = revealpath.clone();
                acloned.clockwise = false;
                arevealmask.addChild(acloned);

                var aprevgroup = aclipgroup;
                aclipgroup = new paper.Group([arevealmask, araster]);
                aclipgroup.clipped = true;
                aprevgroup.remove();

                paper = mypapers[0];
                var cloned = revealpath.clone();
                cloned.clockwise = false;
                revealmask.addChild(cloned);

                var prevgroup = clipgroup;
                clipgroup = new paper.Group([revealmask, raster]);
                clipgroup.clipped = true;
                prevgroup.remove();
                revealpath.remove();

                widthp = null;
                timeout = null;
            }
        };




    </script>

</head>
<body>
    <canvas id="presCanvas" resize style="border: 1px solid black;"></canvas>
    <canvas id="audCanvas" resize style="border: 1px solid black;"></canvas>
    <img id="myImage" src="images/adobe_sf.jpg" style="display:none;">
</body>
</html>